## 核心思路
在人类自然对话过程中，语境（context）作为沟通的隐性框架，在信息理解与记忆重构中扮演着核心角色。尽管个体往往难以完整复述对话中的具体语句，但却能够准确把握其中的关键意义。这表明人类在对话过程中并非被动存储完整言语内容，而是在语义交互中伴随主动的认知加工，通过思考提炼出高层次的抽象信息，并以此构建长期记忆。

受此启发，本文在设计大语言模型（LLM）的多轮对话记忆管理机制时，提出“思考驱动型记忆建构”的框架。该框架主张在记忆生成之前，先引导模型进行“模拟思考”，通过动态调度多个 function 来执行语义解析、意图识别与情境建构等子任务，从而生成具备语用价值的结构化记忆。具体方法包括以下三个核心组成部分：

1. 认知单元建模（Cognitive Unit Modeling）：模型并不直接存储原始对话内容，而是提取对话中的核心认知要素，从原始语料中抽象出具备解释力的语义骨架，构建包括意图图谱、情境图景与行为路径在内的结构化认知单元。

2. 语境维护引擎（Context Maintenance Engine）：该引擎通过控制 LLM 动态调用多个功能模块（functions），模拟多步思考过程，实现对话语境的持续维护。

3. 意图轨迹建模（Intent Trajectory Modeling）：为了防止非相关记忆的激活对对话造成干扰，系统引入基于用户意图识别的记忆调度机制。当用户意图发生显著切换或语境断裂时，系统将跳过旧记忆的调用，以确保语义的一致性和响应的相关性。
## 代码逻辑
* 基础模型
	1. embedding模型
	2. rerank 模型
	2. LLM
* 数据结构
	1. topic 类别：对于记忆的 topic 有一个明确的分类，对于每一个 topic 有一个单独的描述，用于构建 prompt 辅助完成后续记忆的分类。
	2. 时间线：记忆有清晰的时间顺序。
	3. metadata：包括id、时间、topic、相关的其他记忆 link、原始记忆、总结后的记忆、总结后的记忆的 embeddings
* 存储记忆
	1. 让 LLM 完成 function call，维护记忆存储
* 检索记忆
	1. 判断当前 query 的 topic
	2. 用 embedding 模型对 query 进行向量化，在 topic 下进行检索，取 top_k 记忆及其 link 
	3. 构建 prompt，生成答案
## function
### 类别一：记忆编码/组织（偏语义）
1. should_store_memory 
	* 功能：判断当前输入是否值得存入长期记忆
2. summarize_for_memory
	* 功能：将长文本压缩为便于存储的记忆摘要
3. classify_memory_topic
	* 功能：为一段记忆归类话题（支持多标签）
4. detect_memory_conflict
	* 功能：判断新内容与已有记忆是否存在语义冲突
### 类别二：记忆提取与检索辅助
5. extract_memory_query
	* 功能：从用户提问或对话中构建用于记忆检索的 query
6. select_relevant_memories
	* 功能：从检索结果中筛选真正相关的记忆片段
7. link_memory_with_context
	* 功能：判断当前上下文是否应与某记忆建立语义链接
### 类别三：记忆更新与维护
8. is_memory_outdated
	* 功能：判断某条记忆是否已过时或被新信息覆盖
9. merge_memory_items
	* 功能：将两条相近记忆合并为更简洁的表达
10. rewrite_memory_for_consistency
	* 功能：重写旧记忆，使其与当前上下文一致